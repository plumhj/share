# 외부 연동 API 명세서

## 개요

외부 시스템에서 CMYK 시스템으로 회원가입 및 로그인을 연동하기 위한 API입니다.

## 인증

모든 외부 연동 API는 `X-API-Key` 헤더를 통한 API Key 인증이 필요합니다.

| 헤더 | 설명 | 필수 |
|-----|------|------|
| `X-API-Key` | 발급받은 API Key | O |

API Key는 사전에 발급받아야 하며, 각 연동처(Source)별로 고유한 API Key가 발급됩니다.

---

## 1. 외부 회원가입 API

외부 시스템에서 CMYK 시스템으로 회원가입을 수행합니다.

### 기본 정보

| 항목 | 값 |
|-----|-----|
| **URL** | `/api/external/signup` |
| **Method** | `POST` |
| **Content-Type** | `application/json` |

### Request Headers

| 헤더 | 설명 | 필수 |
|-----|------|------|
| `X-API-Key` | 발급받은 API Key | O |
| `Content-Type` | `application/json` | O |

### Request Body

| 필드 | 타입 | 설명 | 필수 |
|-----|------|------|------|
| `id` | string | 사용자 ID (이메일 형식) | O |
| `password` | string | 비밀번호 | O |
| `brNumber` | string | 사업자등록번호 (하이픈 포함/미포함 모두 가능) | O |
| `address` | string | 주소 | X |
| `representativeName` | string | 대표자명 | X |
| `representativePhone` | string | 대표자 전화번호 | X |
| `managerName` | string | 담당자명 | X |
| `managerPhone` | string | 담당자 전화번호 | X |
| `billingEmail` | string | 청구서 수신 이메일 | X |

### Request Example

```json
{
  "id": "user@example.com",
  "password": "securePassword123",
  "brNumber": "123-45-67890",
  "address": "서울시 강남구 테헤란로 123",
  "representativeName": "홍길동",
  "representativePhone": "010-1234-5678",
  "managerName": "김담당",
  "managerPhone": "010-8765-4321",
  "billingEmail": "billing@example.com"
}
```

### Response

#### 성공 (200 OK)

| 필드 | 타입 | 설명 |
|-----|------|------|
| `id` | string | 사용자 아이디 |

```json
{
  "id": "user@example.com"
}
```

#### 실패

| HTTP Status | errorCode | 상황 |
|-------------|-----------|------|
| 400 | `INVALID_REQUEST` | 필수 필드 누락 또는 잘못된 요청 형식 |
| 401 | `UNAUTHORIZED` | API Key 누락 또는 유효하지 않음 |

**에러 응답 형식:**

```json
{
  "code": "INVALID_REQUEST",
  "msg": "ID(이메일)는 필수입니다."
}
```

### 에러 메시지

| 메시지 | 설명 |
|--------|------|
| `잘못된 요청 형식입니다.` | JSON 파싱 실패 |
| `ID(이메일)는 필수입니다.` | id 필드 누락 |
| `비밀번호는 필수입니다.` | password 필드 누락 |
| `사업자등록번호는 필수입니다.` | brNumber 필드 누락 |
| `API Key가 필요합니다.` | X-API-Key 헤더 누락 |
| `유효하지 않은 API Key입니다.` | API Key가 존재하지 않거나 비활성화됨 |

---

## 2. 외부 로그인 API

외부 시스템에서 CMYK 시스템으로 로그인을 수행합니다.
비밀번호 없이 이메일만으로 토큰을 발급받을 수 있으며, 반환된 URL로 리다이렉트하면 자동 로그인됩니다.

### 기본 정보

| 항목 | 값 |
|-----|-----|
| **URL** | `/api/external/signin` |
| **Method** | `POST` |
| **Content-Type** | `application/json` |

### Request Headers

| 헤더 | 설명 | 필수 |
|-----|------|------|
| `X-API-Key` | 발급받은 API Key | O |
| `Content-Type` | `application/json` | O |

### Request Body

| 필드 | 타입 | 설명 | 필수 |
|-----|------|------|------|
| `id` | string | 사용자 아이디 | O |

### Request Example

```json
{
  "id": "user@example.com"
}
```

### Response

#### 성공 (200 OK)

| 필드 | 타입 | 설명 |
|-----|------|------|
| `redirectUrl` | string | 자동 로그인을 위한 리다이렉트 URL |

```json
{
  "redirectUrl": "https://cmyk.example.com/#/external-auth?token=abc123xyz..."
}
```

#### 사용 방법

1. API 호출하여 `redirectUrl` 획득
2. 사용자를 해당 URL로 리다이렉트
3. CMYK 시스템에서 토큰을 검증하고 자동 로그인 처리

#### 실패

| HTTP Status | errorCode | 상황 |
|-------------|-----------|------|
| 400 | `INVALID_REQUEST` | 필수 필드 누락 또는 해당 이메일로 가입된 사용자 없음 |
| 401 | `UNAUTHORIZED` | API Key 누락 또는 유효하지 않음 |

**에러 응답 형식:**

```json
{
  "code": "INVALID_REQUEST",
  "msg": "해당 이메일로 가입된 사용자가 없습니다."
}
```

### 에러 메시지

| 메시지 | 설명 |
|--------|------|
| `잘못된 요청 형식입니다.` | JSON 파싱 실패 |
| `이메일은 필수입니다.` | email 필드 누락 |
| `해당 이메일로 가입된 사용자가 없습니다.` | 해당 연동처에서 가입된 사용자가 없음 |
| `API Key가 필요합니다.` | X-API-Key 헤더 누락 |
| `유효하지 않은 API Key입니다.` | API Key가 존재하지 않거나 비활성화됨 |

### 주의사항

- 해당 API Key의 연동처(Source)에서 가입한 사용자만 로그인 가능합니다.
- 다른 연동처나 일반 가입 사용자는 로그인할 수 없습니다.

---

## 연동 흐름

### 회원가입 흐름

```
┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│ 외부 시스템   │         │  CMYK API    │         │   Database   │
└──────┬───────┘         └──────┬───────┘         └──────┬───────┘
       │                        │                        │
       │ POST /external/signup  │                        │
       │ (X-API-Key 포함)       │                        │
       │───────────────────────>│                        │
       │                        │                        │
       │                        │  API Key 검증          │
       │                        │───────────────────────>│
       │                        │<───────────────────────│
       │                        │                        │
       │                        │  User 생성             │
       │                        │───────────────────────>│
       │                        │<───────────────────────│
       │                        │                        │
       │                        │  Workspace 생성        │
       │                        │───────────────────────>│
       │                        │<───────────────────────│
       │                        │                        │
       │  200 OK                │                        │
       │  {userID, workspaceID} │                        │
       │<───────────────────────│                        │
       │                        │                        │
```

### 로그인 흐름

```
┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│ 외부 시스템   │         │  CMYK API    │         │   사용자     │
└──────┬───────┘         └──────┬───────┘         └──────┬───────┘
       │                        │                        │
       │ POST /external/signin  │                        │
       │ (X-API-Key 포함)       │                        │
       │───────────────────────>│                        │
       │                        │                        │
       │  200 OK                │                        │
       │  {redirectUrl}         │                        │
       │<───────────────────────│                        │
       │                        │                        │
       │  사용자를 redirectUrl로 │                        │
       │  리다이렉트             │                        │
       │────────────────────────────────────────────────>│
       │                        │                        │
       │                        │   토큰 검증 및          │
       │                        │   자동 로그인           │
       │                        │<───────────────────────│
       │                        │                        │
```

---

## cURL 예제

### 회원가입

```bash
curl -X POST 'https://test.cmyk.ne.kr/api/external/signup' \
  -H 'Content-Type: application/json' \
  -H 'X-API-Key: your-api-key-here' \
  -d '{
    "id": "user@example.com",
    "password": "securePassword123",
    "brNumber": "123-45-67890",
    "address": "서울시 강남구 테헤란로 123",
    "representativeName": "홍길동",
    "representativePhone": "010-1234-5678",
    "managerName": "김담당",
    "managerPhone": "010-8765-4321",
    "billingEmail": "billing@example.com"
  }'
```

### 로그인

```bash
curl -X POST 'https://test.cmyk.ne.kr/api/external/signin' \
  -H 'Content-Type: application/json' \
  -H 'X-API-Key: your-api-key-here' \
  -d '{
    "email": "user@example.com"
  }'
```
